require("dotenv").config();
const express = require("express");
const mysql = require("mysql2/promise");
const bcrypt = require("bcrypt");
const app = express();
const PORT = process.env.PORT || 3000;
const os = require("os");
const cors = require("cors");
// ‡πÉ‡∏ä‡πâ Middleware ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JSON
app.use(express.json());

app.use(cors({
  origin: "*", // ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô ["http://example.com", "http://localhost:3000"]
  methods: ["GET", "POST", "PUT", "DELETE"], // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏ò‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
  allowedHeaders: ["Content-Type", "Authorization"] // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ header ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
}));

// const allowedIPs = ["192.168.1.100", "192.168.1.101", "127.0.0.1","192.168.137.1"]; // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô .env ‡πÑ‡∏î‡πâ

// // Middleware ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IP
// const allowedSubnet = ["192.168.137.1","127.0.0.1"]; // Subnet ‡∏Ç‡∏≠‡∏á LAN/WiFi

// const ipFilter = (req, res, next) => {
//   let clientIP = req.ip || req.connection.remoteAddress;

//   // ‡πÅ‡∏õ‡∏•‡∏á IPv6 localhost (::1) ‡πÄ‡∏õ‡πá‡∏ô IPv4 localhost (127.0.0.1)
//   if (clientIP === "::1") clientIP = "127.0.0.1";

//   // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ IP ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Subnet ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
//   const isAllowed = allowedSubnet.some((subnet) => clientIP.startsWith(subnet));

//   if (!isAllowed) {
//     return res
//       .status(403)
//       .json({ error: `Access denied. Unauthorized IP address: ${clientIP}` });
//   }

//   next(); // ‡∏´‡∏≤‡∏Å IP ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Subnet ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
// };

// app.use((req, res, next) => {
//   const clientIP = req.headers["x-forwarded-for"] || req.connection.remoteAddress;
//   console.log("Client IP:", clientIP); // ‡πÅ‡∏™‡∏î‡∏á IP Address ‡∏Ç‡∏≠‡∏á Client
//   next();
// });

const getNetworkIPs = () => {
  const networkInterfaces = os.networkInterfaces(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const ips = [];

  // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á IP ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã
  for (const interfaceName in networkInterfaces) {
    const interfaces = networkInterfaces[interfaceName];

    for (const net of interfaces) {
      if (net.family === "IPv4" && !net.internal) {
        // IPv4 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà localhost (::1 ‡∏´‡∏£‡∏∑‡∏≠ 127.0.0.1)
        ips.push({
          interface: interfaceName,
          address: net.address,
        });
      }
    }
  }

  return ips;
};

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• IP ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
const networkIPs = getNetworkIPs();
console.log("Network Interfaces and IPs:", networkIPs);

// ‡πÉ‡∏ä‡πâ Middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å API
// app.use(ipFilter);

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
let db;
(async () => {
  db = await mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    port: process.env.DB_PORT || 3306,
  });
  console.log("Connected to MySQL database.");
})();

app.get("/get_data_user", async (req, res) => {
  try {
    const [results] = await db.query(`
      SELECT 
        u.id AS user_id, 
        u.title, 
        u.first_name, 
        u.last_name, 
        u.mobile_phone, 
        u.role, 
        u.breach,
        u.membership_status, 
        u.eudr_status, 
        ud.nickname, 
        ud.id_card_number, 
        ud.birth_date, 
        ud.address, 
        ud.phone, 
        ud.owner_percentage, 
        ud.credit_percentage, 
        ud.role_eudr, 
        ud.field_area, 
        ud.bank_account, 
        lt.id AS land_id,
        lt.title_deed_no,
        lt.land_location,
        lt.land_area,
        lt.ownership_type,
        lt.acquired_date,
        lt.land_value
      FROM user u
      LEFT JOIN user_details ud ON u.id = ud.user_id
      LEFT JOIN land_titles lt ON lt.id = u.id  
    `);

    // üîπ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ user_id ‡πÄ‡∏õ‡πá‡∏ô key
    const userMap = new Map();
    
    results.forEach(row => {
      if (!userMap.has(row.user_id)) {
        userMap.set(row.user_id, {
          user_id: row.user_id,
          title: row.title,
          first_name: row.first_name,
          last_name: row.last_name,
          mobile_phone: row.mobile_phone,
          role: row.role,
          breach: row.breach,
          membership_status: row.membership_status,
          eudr_status: row.eudr_status,
          nickname: row.nickname,
          id_card_number: row.id_card_number,
          birth_date: row.birth_date,
          address: row.address,
          phone: row.phone,
          owner_percentage: row.owner_percentage,
          credit_percentage: row.credit_percentage,
          role_eudr: row.role_eudr,
          field_area: row.field_area,
          bank_account: row.bank_account,
          lands: [] // üè° ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
        });
      }

      if (row.land_id) {
        userMap.get(row.user_id).lands.push({
          land_id: row.land_id,
          title_deed_no: row.title_deed_no,
          land_location: row.land_location,
          land_area: row.land_area,
          ownership_type: row.ownership_type,
          acquired_date: row.acquired_date,
          land_value: row.land_value
        });
      }
    });

    res.status(200).json({
      message: "User data retrieved successfully.",
      data: Array.from(userMap.values())
    });
  } catch (error) {
    console.error("‚ùå Error retrieving user data:", error);
    res.status(500).json({ error: "Failed to retrieve user data." });
  }
});



app.get("/get_data_user/:id", async (req, res) => {
  const { id } = req.params;

  try {
    const [results] = await db.query(
      `
      SELECT 
        u.id AS user_id, 
        u.title, 
        u.first_name, 
        u.last_name, 
        u.mobile_phone, 
        u.role, 
        u.breach,
        u.membership_status, 
        u.eudr_status, 
        ud.nickname, 
        ud.id_card_number, 
        ud.birth_date, 
        ud.address, 
        ud.phone, 
        ud.owner_percentage, 
        ud.credit_percentage, 
        ud.role_eudr, 
        ud.field_area, 
        ud.bank_account, 
        lt.id AS land_id,
        lt.title_deed_no,
        lt.land_location,
        lt.land_area,
        lt.ownership_type,
        lt.acquired_date,
        lt.land_value
      FROM user u
      LEFT JOIN user_details ud ON u.id = ud.user_id
      LEFT JOIN land_titles lt ON lt.id = u.id
      WHERE u.id = ?
      `,
      [id]
    );

    if (results.length === 0) {
      return res.status(404).json({ error: "User not found." });
    }

    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
    const userData = {
      user_id: results[0].user_id,
      title: results[0].title,
      first_name: results[0].first_name,
      last_name: results[0].last_name,
      mobile_phone: results[0].mobile_phone,
      role: results[0].role,
      breach:results[0].breach,
      membership_status: results[0].membership_status,
      eudr_status: results[0].eudr_status,
      nickname: results[0].nickname,
      id_card_number: results[0].id_card_number,
      birth_date: results[0].birth_date,
      address: results[0].address,
      phone: results[0].phone,  
      owner_percentage: results[0].owner_percentage,
      credit_percentage: results[0].credit_percentage,
      role_eudr: results[0].role_eudr,
      field_area: results[0].field_area,
      bank_account: results[0].bank_account,
      lands: []
    };

    results.forEach(row => {
      if (row.land_id) {
        userData.lands.push({
          land_id: row.land_id,
          title_deed_no: row.title_deed_no,
          land_location: row.land_location,
          land_area: row.land_area,
          ownership_type: row.ownership_type,
          acquired_date: row.acquired_date,
          land_value: row.land_value
        });
      }
    });

    res.status(200).json({
      message: "User data retrieved successfully.",
      data: userData
    });
  } catch (error) {
    console.error("Error retrieving user data:", error);
    res.status(500).json({ error: "Failed to retrieve user data." });
  }
});



// API ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `user` ‡πÅ‡∏•‡∏∞ `user_details`
app.post("/user-with-details", async (req, res) => {
  const {
    id, // ‡πÉ‡∏ä‡πâ id ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö user
    title,
    first_name,
    last_name,
    mobile_phone,
    role,
    breach,
    membership_status,
    eudr_status,
    nickname,
    id_card_number,
    birth_date,
    address,
    phone,
    owner_percentage,
    credit_percentage,
    role_eudr,
    field_area,
    bank_account,
    land // ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á user (object ‡∏´‡∏£‡∏∑‡∏≠ array)
  } = req.body;

  if (!id || !first_name || !last_name || !mobile_phone) {
    return res.status(400).json({ error: "ID, First Name, Last Name, and Mobile Phone are required." });
  }

  try {
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction
    await db.beginTransaction();

    // ‚úÖ 1. Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `user`
    await db.query(
      `
      INSERT INTO user (id, title, first_name, last_name, mobile_phone, role ,breach, membership_status, eudr_status) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `,
      [id, title || null, first_name, last_name, mobile_phone, role || "user", membership_status || 0, eudr_status || 0]
    );

    // ‚úÖ 2. Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `user_details`
    await db.query(
      `
      INSERT INTO user_details (
        id, user_id, nickname, id_card_number, birth_date, address, phone, 
        owner_percentage, credit_percentage, role_eudr, field_area, bank_account, land_title_id
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `,
      [
        id, id, nickname || null, id_card_number || null, birth_date || null, address || null, phone || null,
        owner_percentage || 0.0, credit_percentage || 0.0, role_eudr || null, field_area || null, bank_account || null, id
      ]
    );

    // ‚úÖ 3. Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `land_titles` (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô)
    if (land) {
      if (Array.isArray(land)) {
        for (const l of land) {
          await db.query(
            `
            INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            `,
            [
              id, // ‡πÉ‡∏ä‡πâ `user.id` ‡πÄ‡∏õ‡πá‡∏ô `id` ‡∏Ç‡∏≠‡∏á land_titles
              l.title_deed_no || null,
              l.land_location || null,
              l.land_area || 0.0,
              l.ownership_type || null,
              l.acquired_date || null,
              l.land_value || 0.0
            ]
          );
        }
      } else {
        await db.query(
          `
          INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
          VALUES (?, ?, ?, ?, ?, ?, ?)
          `,
          [
            id, // ‡πÉ‡∏ä‡πâ `user.id` ‡πÄ‡∏õ‡πá‡∏ô `id` ‡∏Ç‡∏≠‡∏á land_titles
            land.title_deed_no || null,
            land.land_location || null,
            land.land_area || 0.0,
            land.ownership_type || null,
            land.acquired_date || null,
            land.land_value || 0.0
          ]
        );
      }
    }

    // ‚úÖ Commit Transaction
    await db.commit();

    res.status(201).json({
      message: "User, user details, and land information inserted successfully.",
      userId: id,
    });
  } catch (error) {
    // ‚ùå Rollback Transaction ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await db.rollback();
    console.error("Error inserting user, details, and land:", error);
    res.status(500).json({ error: "Failed to insert user, details, and land information." });
  }
});

app.post("/add-land", async (req, res) => {
  const { user_id, land } = req.body; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ user_id ‡πÅ‡∏•‡∏∞ land

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  if (!user_id || !land) {
    return res.status(400).json({ error: "User ID and land data are required." });
  }

  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ user_id ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const [userCheck] = await db.query("SELECT id FROM user WHERE id = ?", [user_id]);
    if (userCheck.length === 0) {
      return res.status(404).json({ error: "User not found." });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction
    await db.beginTransaction();

    if (Array.isArray(land)) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏õ‡∏•‡∏á -> Loop Insert
      for (const l of land) {
        await db.query(
          `
          INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
          VALUES (?, ?, ?, ?, ?, ?, ?)
          `,
          [
            user_id, // ‡πÉ‡∏ä‡πâ user_id ‡πÄ‡∏õ‡πá‡∏ô id ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
            l.title_deed_no || null,
            l.land_location || null,
            l.land_area || 0.0,
            l.ownership_type || null,
            l.acquired_date || null,
            l.land_value || 0.0
          ]
        );
      }
    } else {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -> Insert ‡∏õ‡∏Å‡∏ï‡∏¥
      await db.query(
        `
        INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
        VALUES (?, ?, ?, ?, ?, ?, ?)
        `,
        [
          user_id, // ‡πÉ‡∏ä‡πâ user_id ‡πÄ‡∏õ‡πá‡∏ô id ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
          land.title_deed_no || null,
          land.land_location || null,
          land.land_area || 0.0,
          land.ownership_type || null,
          land.acquired_date || null,
          land.land_value || 0.0
        ]
      );
    }

    // Commit Transaction
    await db.commit();

    res.status(201).json({
      message: "Land information inserted successfully.",
      userId: user_id,
    });
  } catch (error) {
    // Rollback Transaction ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await db.rollback();
    console.error("Error inserting land:", error);
    res.status(500).json({ error: "Failed to insert land information." });
  }
});




// API ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô user ‡πÅ‡∏•‡∏∞ user_details
app.delete("/delete_user/:id", async (req, res) => {
  const { id } = req.params;

  try {
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction
    await db.beginTransaction();

    // üîπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `land_titles` (‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
    await db.query("DELETE FROM land_titles WHERE id = ?", [id]);

    // üîπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `user_details`
    await db.query("DELETE FROM user_details WHERE user_id = ?", [id]);

    // üîπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `auth` (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)
    await db.query("DELETE FROM auth WHERE user_id = ?", [id]);

    // üîπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `user`
    const [result] = await db.query("DELETE FROM user WHERE id = ?", [id]);

    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `user` ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    if (result.affectedRows === 0) {
      return res.status(404).json({ error: "User not found." });
    }

    // ‚úÖ Commit Transaction
    await db.commit();

    res.status(200).json({ message: `User with ID ${id} and all related data deleted successfully.` });

  } catch (error) {
    // ‚ùå Rollback Transaction ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await db.rollback();
    console.error("Error deleting user:", error);
    res.status(500).json({ error: "Failed to delete user and related data." });
  }
});



app.post("/login", async (req, res) => {
  console.log(req.body);
  const { username, password ,breach} = req.body;

  if (!username || !password) {
    return res.status(400).json({ error: "Email and password are required." });
  }

  try {
    // üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å database
    const [users] = await db.query("SELECT * FROM auth WHERE email = ? AND password = ? AND breach = ? LIMIT 1", [username,password ,breach]);

    if (users.length === 0) {
      return res.status(404).json({ error: "User not found." });
    }

    const user = users[0];

    // üîπ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 
    const isPasswordValid =  user.password;
    if (!isPasswordValid) {
      return res.status(401).json({ error: "Invalid password." });
    }

    // üîπ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    res.status(200).json({
      status: 200,
      message: "Login successful.",
      userId: user.id,
      username: user.username,
    });

  } catch (error) {
    console.error("Error logging in:", error);
    res.status(500).json({ error: "Failed to log in." });
  }
});



// API ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô user ‡πÅ‡∏•‡∏∞ user_details
app.put("/update_user/:id", async (req, res) => {
  const { id } = req.params;
  const {
    title,
    first_name,
    last_name,
    mobile_phone,
    role,
    breach,
    membership_status,
    eudr_status,
    nickname,
    id_card_number,
    birth_date,
    address,
    phone,
    owner_percentage,
    credit_percentage,
    role_eudr,
    field_area,
    bank_account,
    land // üè° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  } = req.body;

  try {
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction
    await db.beginTransaction();

    // ‚úÖ 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `user`
    const [userResult] = await db.query(
      `
      UPDATE user 
      SET title = ?, first_name = ?, last_name = ?, mobile_phone = ?, role = ?,breach = ?, 
          membership_status = ?, eudr_status = ?
      WHERE id = ?
      `,
      [title, first_name, last_name, mobile_phone, role,breach, membership_status, eudr_status, id]
    );

    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô `user` ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    if (userResult.affectedRows === 0) {
      return res.status(404).json({ error: "User not found." });
    }

    // ‚úÖ 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `user_details`
    await db.query(
      `
      UPDATE user_details 
      SET nickname = ?, id_card_number = ?, birth_date = ?, address = ?, phone = ?, 
          owner_percentage = ?, credit_percentage = ?, role_eudr = ?, field_area = ?, bank_account = ?
      WHERE user_id = ?
      `,
      [nickname, id_card_number, birth_date, address, phone, owner_percentage, credit_percentage, role_eudr, field_area, bank_account, id]
    );

    // ‚úÖ 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô)
    if (land) {
      if (Array.isArray(land)) {
        for (const l of land) {
          await db.query(
            `
            INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            `,
            [
              id, // ‡πÉ‡∏ä‡πâ `user.id` ‡πÄ‡∏õ‡πá‡∏ô `id` ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
              l.title_deed_no || null,
              l.land_location || null,
              l.land_area || 0.0,
              l.ownership_type || null,
              l.acquired_date || null,
              l.land_value || 0.0
            ]
          );
        }
      } else {
        await db.query(
          `
          INSERT INTO land_titles (id, title_deed_no, land_location, land_area, ownership_type, acquired_date, land_value) 
          VALUES (?, ?, ?, ?, ?, ?, ?)
          `,
          [
            id, // ‡πÉ‡∏ä‡πâ `user.id` ‡πÄ‡∏õ‡πá‡∏ô `id` ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô
            land.title_deed_no || null,
            land.land_location || null,
            land.land_area || 0.0,
            land.ownership_type || null,
            land.acquired_date || null,
            land.land_value || 0.0
          ]
        );
      }
    }

    // ‚úÖ Commit Transaction
    await db.commit();

    res.status(200).json({ 
      message: `User with ID ${id} updated successfully.`,
      userId: id 
    });

  } catch (error) {
    // ‚ùå Rollback Transaction ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await db.rollback();
    console.error("Error updating user and land:", error);
    res.status(500).json({ error: "Failed to update user and land information." });
  }
});


// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
app.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});
